from aiogram import types, F
from aiogram.filters import CommandStart
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from datetime import datetime

from keyboards import (
    get_main_keyboard, get_cancel_keyboard, get_date_keyboard,
    get_transaction_edit_keyboard, get_transaction_type_keyboard,
    get_transactions_list_keyboard
)
from models import P2PTransaction
from config import logger

class TransactionStates(StatesGroup):
    waiting_for_amount = State()
    waiting_for_date = State()
    editing_transaction = State()
    editing_amount = State()
    editing_date = State()
    editing_type = State()

async def register_handlers(dp, db_session):
    
    @dp.message(CommandStart())
    async def send_welcome(message: types.Message):
        keyboard = get_main_keyboard()
        await message.reply(
            "üëã –ü—Ä–∏–≤–µ—Ç! –Ø –ø–æ–º–æ–≥—É —Ç–µ–±–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Ç–≤–æ–∏ P2P —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–∞ Bybit.\n\n"
            "–ò—Å–ø–æ–ª—å–∑—É–π –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:",
            reply_markup=keyboard
        )

    @dp.message(F.text == "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞")
    async def show_statistics(message: types.Message):
        user_id = message.from_user.id
        
        # Get all transactions for the user
        buys = db_session.query(P2PTransaction).filter_by(
            user_id=user_id,
            transaction_type='buy'
        ).order_by(P2PTransaction.date.desc()).all()
        
        sells = db_session.query(P2PTransaction).filter_by(
            user_id=user_id,
            transaction_type='sell'
        ).order_by(P2PTransaction.date.desc()).all()
        
        total_bought = sum(t.amount for t in buys)
        total_sold = sum(t.amount for t in sells)
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        stats = [
            "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤–∞—à–∏—Ö P2P —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:\n",
            f"üí∞ –í—Å–µ–≥–æ –≤–Ω–µ—Å–µ–Ω–æ: {total_bought:,.2f} ‚ÇΩ",
            f"üìà –í—Å–µ–≥–æ –ø–æ–∫—É–ø–æ–∫: {len(buys)}",
            f"üí∏ –í—Å–µ–≥–æ –ø—Ä–æ–¥–∞–Ω–æ: {total_sold:,.2f} ‚ÇΩ",
            f"üìâ –í—Å–µ–≥–æ –ø—Ä–æ–¥–∞–∂: {len(sells)}\n"
        ]
        
        # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π
        if buys:
            stats.append("\nüîµ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è:")
            for t in buys[:5]:
                stats.append(f"‚Ä¢ {t.date.strftime('%d.%m.%Y')}: {t.amount:,.2f} ‚ÇΩ")
        
        # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –ø—Ä–æ–¥–∞–∂
        if sells:
            stats.append("\nüî¥ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø—Ä–æ–¥–∞–∂–∏:")
            for t in sells[:5]:
                stats.append(f"‚Ä¢ {t.date.strftime('%d.%m.%Y')}: {t.amount:,.2f} ‚ÇΩ")
        
        keyboard = get_main_keyboard()
        await message.reply("\n".join(stats), reply_markup=keyboard)

    @dp.message(F.text == "üí∞ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ")
    async def start_add_deposit(message: types.Message, state: FSMContext):
        await state.set_state(TransactionStates.waiting_for_amount)
        await state.update_data(transaction_type='buy')
        keyboard = get_cancel_keyboard()
        await message.reply(
            "–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –≤ —Ä—É–±–ª—è—Ö:",
            reply_markup=keyboard
        )

    @dp.message(F.text == "üí∏ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥–∞–∂—É")
    async def start_add_sell(message: types.Message, state: FSMContext):
        await state.set_state(TransactionStates.waiting_for_amount)
        await state.update_data(transaction_type='sell')
        keyboard = get_cancel_keyboard()
        await message.reply(
            "–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –ø—Ä–æ–¥–∞–∂–∏ –≤ —Ä—É–±–ª—è—Ö:",
            reply_markup=keyboard
        )

    @dp.message(F.text == "‚ùå –û—Ç–º–µ–Ω–∞")
    async def cancel_operation(message: types.Message, state: FSMContext):
        current_state = await state.get_state()
        if current_state is not None:
            await state.clear()
        keyboard = get_main_keyboard()
        await message.reply(
            "–û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞.",
            reply_markup=keyboard
        )

    @dp.message(TransactionStates.waiting_for_amount)
    async def process_amount(message: types.Message, state: FSMContext):
        try:
            amount = float(message.text.replace(',', '.'))
            if amount <= 0:
                raise ValueError("Amount must be positive")
            
            # Save amount to state and ask for date
            await state.update_data(amount=amount)
            await state.set_state(TransactionStates.waiting_for_date)
            
            keyboard = get_date_keyboard()
            await message.reply(
                "–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì (–Ω–∞–ø—Ä–∏–º–µ—Ä, 25.02.2024)\n"
                "–ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã:",
                reply_markup=keyboard
            )
            
        except ValueError:
            keyboard = get_cancel_keyboard()
            await message.reply(
                "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ.",
                reply_markup=keyboard
            )

    @dp.message(TransactionStates.waiting_for_date)
    async def process_date(message: types.Message, state: FSMContext):
        try:
            # Get saved data
            state_data = await state.get_data()
            amount = state_data.get('amount')
            transaction_type = state_data.get('transaction_type')
            
            # Parse date or use current date if button clicked
            text = message.text.strip() if message.text else ""
            if text == "üìÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É":
                date = datetime.now()
            else:
                try:
                    date = datetime.strptime(text, "%d.%m.%Y")
                except ValueError:
                    await message.reply(
                        "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç –î–î.–ú–ú.–ì–ì–ì–ì (–Ω–∞–ø—Ä–∏–º–µ—Ä, 25.02.2024)\n"
                        "–ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã",
                        reply_markup=get_date_keyboard()
                    )
                    return
            
            # Create and save transaction
            transaction = P2PTransaction(
                user_id=message.from_user.id,
                amount=amount,
                transaction_type=transaction_type,
                date=date
            )
            db_session.add(transaction)
            db_session.commit()
            
            await state.clear()
            
            action_type = "–ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ" if transaction_type == 'buy' else "–ø—Ä–æ–¥–∞–∂–∞"
            keyboard = get_main_keyboard()
            await message.reply(
                f"‚úÖ {action_type.capitalize()} –Ω–∞ —Å—É–º–º—É {amount:,.2f} ‚ÇΩ "
                f"–æ—Ç {date.strftime('%d.%m.%Y')} —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!",
                reply_markup=keyboard
            )
            
        except Exception as e:
            logger.error(f"Error processing date: {e}")
            keyboard = get_main_keyboard()
            await message.reply(
                "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.",
                reply_markup=keyboard
            )
            await state.clear()

    @dp.message(F.text == "üìù –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏")
    async def show_transactions_for_edit(message: types.Message):
        user_id = message.from_user.id
        
        # Get all transactions for the user
        transactions = db_session.query(P2PTransaction).filter_by(
            user_id=user_id
        ).order_by(P2PTransaction.date.desc()).all()
        
        if not transactions:
            await message.reply(
                "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.",
                reply_markup=get_main_keyboard()
            )
            return
        
        keyboard = get_transactions_list_keyboard(transactions)
        await message.reply(
            "–í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:",
            reply_markup=keyboard
        )

    @dp.callback_query(lambda c: c.data.startswith('edit_'))
    async def edit_transaction(callback_query: types.CallbackQuery, state: FSMContext):
        transaction_id = int(callback_query.data.split('_')[1])
        
        # Get transaction
        transaction = db_session.query(P2PTransaction).filter_by(id=transaction_id).first()
        if not transaction:
            await callback_query.message.reply(
                "‚ùå –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.",
                reply_markup=get_main_keyboard()
            )
            return
        
        # Save transaction id to state
        await state.update_data(editing_transaction_id=transaction_id)
        await state.set_state(TransactionStates.editing_transaction)
        
        action_type = "–ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ" if transaction.transaction_type == 'buy' else "–ø—Ä–æ–¥–∞–∂–∞"
        keyboard = get_transaction_edit_keyboard()
        
        await callback_query.message.reply(
            f"–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:\n"
            f"–¢–∏–ø: {action_type}\n"
            f"–°—É–º–º–∞: {transaction.amount:,.2f} ‚ÇΩ\n"
            f"–î–∞—Ç–∞: {transaction.date.strftime('%d.%m.%Y')}\n\n"
            f"–í—ã–±–µ—Ä–∏—Ç–µ, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å:",
            reply_markup=keyboard
        )
        await callback_query.answer()

    @dp.callback_query(lambda c: c.data == 'cancel_edit')
    async def cancel_edit(callback_query: types.CallbackQuery, state: FSMContext):
        await state.clear()
        await callback_query.message.reply(
            "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.",
            reply_markup=get_main_keyboard()
        )
        await callback_query.answer()

    @dp.message(TransactionStates.editing_transaction, F.text == "üíµ –ò–∑–º–µ–Ω–∏—Ç—å —Å—É–º–º—É")
    async def start_edit_amount(message: types.Message, state: FSMContext):
        await state.set_state(TransactionStates.editing_amount)
        keyboard = get_cancel_keyboard()
        await message.reply(
            "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Å—É–º–º—É –≤ —Ä—É–±–ª—è—Ö:",
            reply_markup=keyboard
        )

    @dp.message(TransactionStates.editing_transaction, F.text == "üìÖ –ò–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—É")
    async def start_edit_date(message: types.Message, state: FSMContext):
        await state.set_state(TransactionStates.editing_date)
        keyboard = get_date_keyboard()
        await message.reply(
            "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì (–Ω–∞–ø—Ä–∏–º–µ—Ä, 25.02.2024)\n"
            "–ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã:",
            reply_markup=keyboard
        )

    @dp.message(TransactionStates.editing_transaction, F.text == "üîÑ –ò–∑–º–µ–Ω–∏—Ç—å —Ç–∏–ø")
    async def start_edit_type(message: types.Message, state: FSMContext):
        await state.set_state(TransactionStates.editing_type)
        keyboard = get_transaction_type_keyboard()
        await message.reply(
            "–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π —Ç–∏–ø —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:",
            reply_markup=keyboard
        )

    @dp.message(TransactionStates.editing_amount)
    async def process_edit_amount(message: types.Message, state: FSMContext):
        try:
            amount = float(message.text.replace(',', '.'))
            if amount <= 0:
                raise ValueError("Amount must be positive")
            
            # Get transaction id from state
            state_data = await state.get_data()
            transaction_id = state_data.get('editing_transaction_id')
            
            # Update transaction
            transaction = db_session.query(P2PTransaction).filter_by(id=transaction_id).first()
            if transaction:
                transaction.amount = amount
                db_session.commit()
                
                await state.clear()
                keyboard = get_main_keyboard()
                await message.reply(
                    f"‚úÖ –°—É–º–º–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ {amount:,.2f} ‚ÇΩ",
                    reply_markup=keyboard
                )
            else:
                raise ValueError("Transaction not found")
            
        except ValueError as e:
            keyboard = get_cancel_keyboard()
            await message.reply(
                "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ.",
                reply_markup=keyboard
            )
        except Exception as e:
            logger.error(f"Error editing amount: {e}")
            keyboard = get_main_keyboard()
            await message.reply(
                "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.",
                reply_markup=keyboard
            )
            await state.clear()

    @dp.message(TransactionStates.editing_date)
    async def process_edit_date(message: types.Message, state: FSMContext):
        try:
            # Get transaction id from state
            state_data = await state.get_data()
            transaction_id = state_data.get('editing_transaction_id')
            
            # Parse date or use current date if button clicked
            text = message.text.strip() if message.text else ""
            if text == "üìÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É":
                date = datetime.now()
            else:
                try:
                    date = datetime.strptime(text, "%d.%m.%Y")
                except ValueError:
                    await message.reply(
                        "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç –î–î.–ú–ú.–ì–ì–ì–ì (–Ω–∞–ø—Ä–∏–º–µ—Ä, 25.02.2024)\n"
                        "–ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã",
                        reply_markup=get_date_keyboard()
                    )
                    return
            
            # Update transaction
            transaction = db_session.query(P2PTransaction).filter_by(id=transaction_id).first()
            if transaction:
                transaction.date = date
                db_session.commit()
                
                await state.clear()
                keyboard = get_main_keyboard()
                await message.reply(
                    f"‚úÖ –î–∞—Ç–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ {date.strftime('%d.%m.%Y')}",
                    reply_markup=keyboard
                )
            else:
                raise ValueError("Transaction not found")
            
        except Exception as e:
            logger.error(f"Error editing date: {e}")
            keyboard = get_main_keyboard()
            await message.reply(
                "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.",
                reply_markup=keyboard
            )
            await state.clear()

    @dp.message(TransactionStates.editing_type)
    async def process_edit_type(message: types.Message, state: FSMContext):
        try:
            # Get transaction id from state
            state_data = await state.get_data()
            transaction_id = state_data.get('editing_transaction_id')
            
            # Determine new type
            if message.text == "üí∞ –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ":
                new_type = 'buy'
            elif message.text == "üí∏ –ü—Ä–æ–¥–∞–∂–∞":
                new_type = 'sell'
            else:
                await message.reply(
                    "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –∏—Å–ø–æ–ª—å–∑—É—è –∫–Ω–æ–ø–∫–∏.",
                    reply_markup=get_transaction_type_keyboard()
                )
                return
            
            # Update transaction
            transaction = db_session.query(P2PTransaction).filter_by(id=transaction_id).first()
            if transaction:
                transaction.transaction_type = new_type
                db_session.commit()
                
                await state.clear()
                keyboard = get_main_keyboard()
                action_type = "–ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ" if new_type == 'buy' else "–ø—Ä–æ–¥–∞–∂—É"
                await message.reply(
                    f"‚úÖ –¢–∏–ø —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ {action_type}",
                    reply_markup=keyboard
                )
            else:
                raise ValueError("Transaction not found")
            
        except Exception as e:
            logger.error(f"Error editing type: {e}")
            keyboard = get_main_keyboard()
            await message.reply(
                "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.",
                reply_markup=keyboard
            )
            await state.clear() 